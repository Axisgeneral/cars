<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals Search Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .search-box { margin: 10px 0; }
        .search-box input, .search-box select { padding: 8px; margin: 5px; }
        .results { margin-top: 15px; }
        .deal-item { padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 4px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .info { color: blue; font-weight: bold; }
        .highlight { background-color: yellow; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .test-results { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Deals Search Fix Verification</h1>
    <p>This test verifies that the phone number search functionality is working correctly in the deals page.</p>
    
    <div class="test-section">
        <h3>Issue Description</h3>
        <p>The deals search had a "Phone Number" option in the dropdown, but the search function didn't handle phone number searches. 
        This was because:</p>
        <ul>
            <li>The search criteria dropdown included "phone" as an option (and it was selected by default)</li>
            <li>The filterDeals() function didn't have a case for "phone" in the switch statement</li>
            <li>Deal records don't directly contain phone numbers, but customers do</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>Test Phone Number Search</h3>
        <div class="search-box">
            <select id="search-criteria">
                <option value="phone" selected>Phone Number</option>
                <option value="customer">Customer</option>
                <option value="vehicle">Vehicle</option>
                <option value="salesperson">Salesperson</option>
                <option value="all">All Fields</option>
            </select>
            <input type="text" id="search-input" placeholder="Enter phone number (e.g., 555-123)...">
            <button onclick="testPhoneSearch()">Search</button>
            <button onclick="testAllSearches()">Test All Scenarios</button>
        </div>
        <div id="results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>Sample Phone Numbers to Test</h3>
        <div id="phone-samples"></div>
    </div>

    <script src="js/data-service.js"></script>
    <script>
        // Initialize data
        DataService.utils.initializeAllData();
        
        // Display sample phone numbers
        function displayPhoneNumbers() {
            const deals = DataService.deals.getAll();
            const phoneSamplesDiv = document.getElementById('phone-samples');
            
            let html = '<p>Try searching for these phone numbers:</p><ul>';
            deals.slice(0, 5).forEach(deal => {
                const customer = DataService.customers.get(deal.customerId);
                if (customer && customer.phone) {
                    html += `<li><strong>${customer.phone}</strong> - ${deal.customerName} (${deal.vehicleYear} ${deal.vehicleMake} ${deal.vehicleModel})</li>`;
                }
            });
            html += '</ul>';
            phoneSamplesDiv.innerHTML = html;
        }
        
        // Test phone search functionality
        function testPhoneSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const searchCriteria = document.getElementById('search-criteria').value;
            const resultsDiv = document.getElementById('results');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '<div class="error">Please enter a search term</div>';
                return;
            }
            
            const deals = DataService.deals.getAll();
            let filteredDeals = [];
            
            // Apply the same search logic as in deals.html
            filteredDeals = deals.filter(deal => {
                switch (searchCriteria) {
                    case 'customer':
                        return deal.customerName.toLowerCase().includes(searchTerm) ||
                               deal.customerEmail.toLowerCase().includes(searchTerm);
                    case 'phone':
                        // Look up customer phone number by customerId
                        const customer = DataService.customers.get(deal.customerId);
                        if (customer && customer.phone) {
                            return customer.phone.toLowerCase().includes(searchTerm);
                        }
                        return false;
                    case 'vehicle':
                        return deal.vehicleMake.toLowerCase().includes(searchTerm) ||
                               deal.vehicleModel.toLowerCase().includes(searchTerm) ||
                               deal.vehicleYear.toString().includes(searchTerm);
                    case 'salesperson':
                        return deal.salesperson.toLowerCase().includes(searchTerm);
                    case 'all':
                    default:
                        // For 'all' search, also include phone number search
                        let matchesAll = deal.customerName.toLowerCase().includes(searchTerm) ||
                               deal.customerEmail.toLowerCase().includes(searchTerm) ||
                               deal.vehicleMake.toLowerCase().includes(searchTerm) ||
                               deal.vehicleModel.toLowerCase().includes(searchTerm) ||
                               deal.vehicleYear.toString().includes(searchTerm) ||
                               deal.salesperson.toLowerCase().includes(searchTerm);
                        
                        // Also search phone number for 'all' criteria
                        if (!matchesAll) {
                            const customer = DataService.customers.get(deal.customerId);
                            if (customer && customer.phone) {
                                matchesAll = customer.phone.toLowerCase().includes(searchTerm);
                            }
                        }
                        
                        return matchesAll;
                }
            });
            
            // Display results
            if (filteredDeals.length === 0) {
                resultsDiv.innerHTML = `<div class="error">No deals found matching "${searchTerm}" in ${searchCriteria} field(s)</div>`;
            } else {
                let html = `<div class="success">✓ Found ${filteredDeals.length} deal(s) matching "${searchTerm}" in ${searchCriteria} field(s):</div>`;
                filteredDeals.forEach(deal => {
                    const customer = DataService.customers.get(deal.customerId);
                    const phoneDisplay = customer && customer.phone ? customer.phone : 'N/A';
                    const highlightedPhone = phoneDisplay.toLowerCase().includes(searchTerm) ? 
                        phoneDisplay.replace(new RegExp(searchTerm, 'gi'), `<span class="highlight">${searchTerm}</span>`) : phoneDisplay;
                    
                    html += `
                        <div class="deal-item">
                            <strong>Customer:</strong> ${deal.customerName}<br>
                            <strong>Phone:</strong> ${highlightedPhone}<br>
                            <strong>Vehicle:</strong> ${deal.vehicleYear} ${deal.vehicleMake} ${deal.vehicleModel}<br>
                            <strong>Salesperson:</strong> ${deal.salesperson}
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
            }
        }
        
        // Test all search scenarios
        function testAllSearches() {
            const resultsDiv = document.getElementById('results');
            const deals = DataService.deals.getAll();
            
            let testResults = '<div class="test-results"><h4>Comprehensive Search Test Results:</h4>';
            
            // Test 1: Phone search with partial number
            const testPhone = '555-123';
            let phoneMatches = deals.filter(deal => {
                const customer = DataService.customers.get(deal.customerId);
                return customer && customer.phone && customer.phone.toLowerCase().includes(testPhone.toLowerCase());
            });
            testResults += `<p><strong>Test 1 - Phone Search ("${testPhone}"):</strong> ${phoneMatches.length > 0 ? '<span class="success">✓ PASS</span>' : '<span class="error">✗ FAIL</span>'} - Found ${phoneMatches.length} matches</p>`;
            
            // Test 2: Customer name search
            const testCustomer = 'john';
            let customerMatches = deals.filter(deal => deal.customerName.toLowerCase().includes(testCustomer));
            testResults += `<p><strong>Test 2 - Customer Search ("${testCustomer}"):</strong> ${customerMatches.length > 0 ? '<span class="success">✓ PASS</span>' : '<span class="error">✗ FAIL</span>'} - Found ${customerMatches.length} matches</p>`;
            
            // Test 3: Vehicle search
            const testVehicle = 'toyota';
            let vehicleMatches = deals.filter(deal => 
                deal.vehicleMake.toLowerCase().includes(testVehicle) ||
                deal.vehicleModel.toLowerCase().includes(testVehicle)
            );
            testResults += `<p><strong>Test 3 - Vehicle Search ("${testVehicle}"):</strong> ${vehicleMatches.length > 0 ? '<span class="success">✓ PASS</span>' : '<span class="error">✗ FAIL</span>'} - Found ${vehicleMatches.length} matches</p>`;
            
            // Test 4: All fields search with phone number
            let allFieldsMatches = deals.filter(deal => {
                let matchesAll = deal.customerName.toLowerCase().includes(testPhone) ||
                       deal.customerEmail.toLowerCase().includes(testPhone) ||
                       deal.vehicleMake.toLowerCase().includes(testPhone) ||
                       deal.vehicleModel.toLowerCase().includes(testPhone) ||
                       deal.salesperson.toLowerCase().includes(testPhone);
                
                if (!matchesAll) {
                    const customer = DataService.customers.get(deal.customerId);
                    if (customer && customer.phone) {
                        matchesAll = customer.phone.toLowerCase().includes(testPhone);
                    }
                }
                
                return matchesAll;
            });
            testResults += `<p><strong>Test 4 - All Fields Search with Phone ("${testPhone}"):</strong> ${allFieldsMatches.length > 0 ? '<span class="success">✓ PASS</span>' : '<span class="error">✗ FAIL</span>'} - Found ${allFieldsMatches.length} matches</p>`;
            
            testResults += '</div>';
            
            // Show summary
            const totalTests = 4;
            const passedTests = [phoneMatches, customerMatches, vehicleMatches, allFieldsMatches].filter(test => test.length > 0).length;
            testResults += `<div class="info">Summary: ${passedTests}/${totalTests} tests passed</div>`;
            
            resultsDiv.innerHTML = testResults;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            displayPhoneNumbers();
        });
        
        // Allow Enter key to trigger search
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testPhoneSearch();
            }
        });
    </script>
</body>
</html>