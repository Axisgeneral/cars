<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - TheOnePages</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/loading.css">
    <link rel="stylesheet" href="styles/modal.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/logo.png" alt="TheOnePages Logo" class="logo">
                <h2>TheOnePages</h2>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li>
                        <a href="inventory.html"><i class="fas fa-car"></i> Inventory</a>
                    </li>
                    <li>
                        <a href="leads.html"><i class="fas fa-funnel-dollar"></i> Leads</a>
                    </li>
                    <li class="active">
                        <a href="customers.html"><i class="fas fa-users"></i> Customers</a>
                    </li>
                    <li>
                        <a href="deals.html"><i class="fas fa-handshake"></i> Deals</a>
                    </li>
                    <li>
                        <a href="four-square.html"><i class="fas fa-calculator"></i> Four Square</a>
                    </li>
                    <li>
                        <a href="tasks.html"><i class="fas fa-tasks"></i> Tasks</a>
                    </li>
                    <li>
                        <a href="reports.html"><i class="fas fa-chart-bar"></i> Reports</a>
                    </li>
                    <li>
                        <a href="service-parts.html"><i class="fas fa-wrench"></i> Service/Parts</a>
                    </li>
                    <li>
                        <a href="payroll-scheduling.html"><i class="fas fa-calendar-alt"></i> Payroll & Scheduling</a>
                    </li>
                    <li>
                        <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
                    </li>
                    <li>
                        <a href="tech-support.html"><i class="fas fa-headset"></i> Tech Support</a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar avatar-placeholder">TM</div>
                    <div class="user-details">
                        <p class="user-name">Thomas Morales</p>
                        <p class="user-role">Sales Manager</p>
                    </div>
                </div>
                <a href="logout.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Top Navigation Bar -->
            <header class="top-nav">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search customers...">
                </div>
                
                <div class="top-nav-actions">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary"><i class="fas fa-plus"></i> New Customer</button>
                        <button class="btn btn-secondary" id="customer-filter-btn"><i class="fas fa-filter"></i> Filter</button>
                    </div>
                </div>
            </header>

            <!-- Customers Content -->
            <div class="dashboard-container">
                <div class="page-header">
                    <h1>Customer Management</h1>
                    <div class="date-filter">
                        <label for="date-range">Date Range:</label>
                        <select id="date-range">
                            <option>Today</option>
                            <option>Yesterday</option>
                            <option>Last 7 Days</option>
                            <option selected>This Month</option>
                            <option>Last Month</option>
                            <option>All Time</option>
                            <option>Custom Range</option>
                        </select>
                    </div>
                </div>

                <!-- Customer Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-customers">0</h3>
                            <p>Total Customers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="new-customers">0</h3>
                            <p>New This Month</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="vip-customers">0</h3>
                            <p>VIP Customers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="active-deals">0</h3>
                            <p>Active Deals</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Table -->
                <div class="table-container">
                    <div class="table-header">
                        <h2>Customer List</h2>
                        <div class="table-actions">
                            <div class="search-container-enhanced">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="customer-search" placeholder="Search customers...">
                                </div>
                                <select id="search-criteria" class="search-criteria-dropdown">
                                    <option value="all">All Fields</option>
                                    <option value="name">Name</option>
                                    <option value="phone" selected>Phone Number</option>
                                    <option value="email">Email</option>
                                    <option value="company">Company</option>
                                </select>
                            </div>
                            <div class="table-action-buttons">
                                <button class="btn btn-secondary" id="import-customers-btn">
                                    <i class="fas fa-upload"></i> Import
                                </button>
                                <button class="btn btn-secondary" id="export-customers-btn">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <select id="customer-filter">
                                    <option value="">All Customers</option>
                                    <option value="VIP">VIP</option>
                                    <option value="Regular">Regular</option>
                                    <option value="New">New</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="data-table" id="customers-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Type</th>
                                    <th>Date Added</th>
                                    <th>Last Contact</th>
                                    <th>Purchases</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-tbody">
                                <!-- Customer rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-customers" class="no-data" style="display: none;">
                        <i class="fas fa-users"></i>
                        <h3>No Customers Found</h3>
                        <p>Start by adding your first customer to the system.</p>
                        <button class="btn btn-primary" id="add-first-customer">
                            <i class="fas fa-plus"></i> Add Customer
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="customers-file-input" accept=".csv,.json" style="display: none;">

    <!-- Import Modal -->
    <div id="import-customers-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-content">
            <div class="modal-header">
                <h2>Import Customers</h2>
                <span class="close" id="close-import-customers-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="import-instructions">
                    <h3>Import Instructions</h3>
                    <p>You can import customers from a CSV or JSON file. Please ensure your file contains the following columns:</p>
                    <ul>
                        <li><strong>firstName</strong> - Customer's first name</li>
                        <li><strong>lastName</strong> - Customer's last name</li>
                        <li><strong>email</strong> - Email address</li>
                        <li><strong>phone</strong> - Phone number</li>
                        <li><strong>address</strong> - Address information (street, city, state, zip)</li>
                        <li><strong>type</strong> - Customer type (VIP, Regular, New)</li>
                        <li><strong>company</strong> - Company name (optional)</li>
                        <li><strong>notes</strong> - Additional notes (optional)</li>
                    </ul>
                </div>
                <div class="file-upload-area">
                    <div class="upload-zone" id="customers-upload-zone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag and drop your file here, or click to select</p>
                        <p class="file-types">Supported formats: CSV, JSON</p>
                    </div>
                    <div id="customers-file-info" class="file-info" style="display: none;">
                        <i class="fas fa-file"></i>
                        <span id="customers-file-name"></span>
                        <button type="button" id="customers-remove-file" class="btn-remove">Ã—</button>
                    </div>
                </div>
                <div class="import-options">
                    <label>
                        <input type="checkbox" id="customers-skip-duplicates" checked>
                        Skip duplicate entries (based on email)
                    </label>
                </div>
                <div id="customers-import-preview" class="import-preview" style="display: none;">
                    <h4>Preview (first 5 rows)</h4>
                    <div class="preview-table-container">
                        <table id="customers-preview-table" class="preview-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-import-customers">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-import-customers" disabled>Import Customers</button>
            </div>
            </div>
        </div>
    </div>

    <script src="js/theme-manager.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/date-filter-utils.js"></script>
    <script src="js/modal-utils.js"></script>
    <script src="js/customers-data.js"></script>
    <script src="js/mobile-nav.js"></script>
    <script>
        // Global functions for customer actions - Define these first before they're used
        window.viewCustomer = function(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            const modalContent = `
                <div class="customer-details">
                    <div class="customer-header">
                        <div class="customer-avatar">
                            ${customer.firstName.charAt(0)}${customer.lastName.charAt(0)}
                        </div>
                        <div class="customer-info">
                            <h3>${customer.firstName} ${customer.lastName}</h3>
                            <p class="customer-type">${customer.type || 'Regular'} Customer</p>
                        </div>
                    </div>
                    
                    <div class="customer-details-grid">
                        <div class="detail-section">
                            <h4>Contact Information</h4>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span>${customer.email}</span>
                            </div>
                            <div class="detail-item">
                                <label>Phone:</label>
                                <span>${customer.phone}</span>
                            </div>
                            <div class="detail-item">
                                <label>Address:</label>
                                <span>${customer.street || ''}<br>${customer.city || ''}, ${customer.state || ''} ${customer.zip || ''}</span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Customer Information</h4>
                            <div class="detail-item">
                                <label>Type:</label>
                                <span class="badge badge-${(customer.type || 'regular').toLowerCase()}">${customer.type || 'Regular'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Company:</label>
                                <span>${customer.company || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Date Added:</label>
                                <span>${formatDate(customer.dateAdded)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Last Contact:</label>
                                <span>${formatDate(customer.lastContact)}</span>
                            </div>
                        </div>
                        
                        <div class="detail-section full-width">
                            <h4>Notes</h4>
                            <div class="notes-content">
                                ${customer.notes || 'No notes available'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const footerButtons = [
                {
                    text: 'Close',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'Edit Customer',
                    class: 'btn-primary',
                    icon: 'fas fa-edit',
                    attributes: `onclick="ModalUtils.closeModal('view-customer-modal'); ModalUtils.removeModal('view-customer-modal'); editCustomer('${customerId}')"`
                }
            ];
            
            ModalUtils.createModal('view-customer-modal', 'Customer Details', modalContent, footerButtons);
            ModalUtils.openModal('view-customer-modal');
        };

        window.addNoteToCustomer = function(customerId) {
            alert('Add Note for customer ID: ' + customerId);
        };

        window.deleteCustomer = function(customerId) {
            // Use the same logic as your main deleteCustomer function
            const customer = DataService.customers.get(customerId);
            if (!customer) return;
            if (confirm(`Are you sure you want to delete ${customer.firstName} ${customer.lastName}? This action cannot be undone.`)) {
                DataService.customers.remove(customerId);
                ModalUtils.showSuccessMessage('Customer deleted successfully!');
                loadCustomers();
                updateStats();
            }
        };

        window.createDealForCustomer = function(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            // Redirect to deals page with customer pre-selected
            window.location.href = `deals.html?customerId=${customerId}&customerName=${encodeURIComponent(customer.firstName + ' ' + customer.lastName)}`;
        };

        window.sendEmailToCustomer = function(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            if (customer.email) {
                window.location.href = `mailto:${customer.email}?subject=Follow up from TheOnePages`;
            } else {
                alert('No email address found for this customer');
            }
        };

        window.logCallForCustomer = function(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            const modalContent = `
                <form id="log-call-form">
                    <div class="form-group">
                        <label for="call-type">Call Type</label>
                        <select id="call-type" name="callType" required>
                            <option value="">Select call type</option>
                            <option value="outbound">Outbound Call</option>
                            <option value="inbound">Inbound Call</option>
                            <option value="follow-up">Follow-up Call</option>
                            <option value="sales">Sales Call</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="call-duration">Duration (minutes)</label>
                        <input type="number" id="call-duration" name="duration" min="1" placeholder="e.g., 15">
                    </div>
                    <div class="form-group">
                        <label for="call-notes">Call Notes</label>
                        <textarea id="call-notes" name="notes" rows="4" placeholder="What was discussed during the call?" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="follow-up-required">
                            <input type="checkbox" id="follow-up-required" name="followUpRequired">
                            Follow-up required
                        </label>
                    </div>
                </form>
            `;
            
            const footerButtons = [
                {
                    text: 'Cancel',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'Log Call',
                    class: 'btn-primary',
                    icon: 'fas fa-phone',
                    attributes: 'onclick="saveCallLog()"'
                }
            ];
            
            ModalUtils.createModal('log-call-modal', `Log Call - ${customer.firstName} ${customer.lastName}`, modalContent, footerButtons);
            ModalUtils.openModal('log-call-modal');
        };

        window.saveCallLog = function() {
            const form = document.getElementById('log-call-form');
            const errors = ModalUtils.validateForm(form);
            
            if (Object.keys(errors).length > 0) {
                ModalUtils.displayFormErrors(errors);
                return;
            }
            
            const formData = ModalUtils.getFormData(form);
            
            // Here you would typically save the call log to your data service
            // For now, we'll just show a success message
            ModalUtils.showSuccessMessage('Call logged successfully!');
            ModalUtils.closeModal('log-call-modal');
            ModalUtils.removeModal('log-call-modal');
        };

        window.openCreditApplication = function(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            const modalContent = `
                <form id="credit-application-form">
                    <div class="form-section">
                        <h4 class="form-section-title">Customer Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Customer Name</label>
                                <input type="text" value="${customer.firstName} ${customer.lastName}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" value="${customer.email}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" value="${customer.phone}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <input type="text" value="${customer.street || ''} ${customer.city || ''}, ${customer.state || ''} ${customer.zip || ''}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Employment Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="employer">Employer *</label>
                                <input type="text" id="employer" name="employer" required placeholder="Current employer">
                            </div>
                            <div class="form-group">
                                <label for="job-title">Job Title *</label>
                                <input type="text" id="job-title" name="jobTitle" required placeholder="Position/Title">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="employment-length">Length of Employment *</label>
                                <select id="employment-length" name="employmentLength" required>
                                    <option value="">Select duration</option>
                                    <option value="less-than-1">Less than 1 year</option>
                                    <option value="1-2">1-2 years</option>
                                    <option value="2-5">2-5 years</option>
                                    <option value="5-10">5-10 years</option>
                                    <option value="more-than-10">More than 10 years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monthly-income">Monthly Income *</label>
                                <input type="number" id="monthly-income" name="monthlyIncome" required placeholder="0" min="0" step="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Financial Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ssn">Social Security Number *</label>
                                <input type="text" id="ssn" name="ssn" required placeholder="XXX-XX-XXXX" maxlength="11">
                            </div>
                            <div class="form-group">
                                <label for="date-of-birth">Date of Birth *</label>
                                <input type="date" id="date-of-birth" name="dateOfBirth" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="housing-status">Housing Status *</label>
                                <select id="housing-status" name="housingStatus" required>
                                    <option value="">Select status</option>
                                    <option value="own">Own</option>
                                    <option value="rent">Rent</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monthly-payment">Monthly Housing Payment *</label>
                                <input type="number" id="monthly-payment" name="monthlyPayment" required placeholder="0" min="0" step="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Credit Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="credit-score">Estimated Credit Score</label>
                                <select id="credit-score" name="creditScore">
                                    <option value="">Select range</option>
                                    <option value="excellent">Excellent (750+)</option>
                                    <option value="good">Good (700-749)</option>
                                    <option value="fair">Fair (650-699)</option>
                                    <option value="poor">Poor (600-649)</option>
                                    <option value="very-poor">Very Poor (Below 600)</option>
                                    <option value="unknown">Don't Know</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="down-payment">Down Payment Amount</label>
                                <input type="number" id="down-payment" name="downPayment" placeholder="0" min="0" step="500">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="trade-vehicle">Trade-in Vehicle</label>
                            <input type="text" id="trade-vehicle" name="tradeVehicle" placeholder="Year Make Model (if applicable)">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Additional Information</h4>
                        <div class="form-group">
                            <label for="bankruptcy">
                                <input type="checkbox" id="bankruptcy" name="bankruptcy">
                                Has filed for bankruptcy in the last 7 years
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="cosigner">
                                <input type="checkbox" id="cosigner" name="cosigner">
                                Will have a co-signer
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="additional-notes">Additional Notes</label>
                            <textarea id="additional-notes" name="additionalNotes" rows="3" placeholder="Any additional information that might help with the credit application..."></textarea>
                        </div>
                    </div>
                </form>
            `;
            
            const footerButtons = [
                {
                    text: 'Cancel',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'Submit Application',
                    class: 'btn-primary',
                    icon: 'fas fa-credit-card',
                    attributes: 'onclick="submitCreditApplication()"'
                }
            ];
            
            ModalUtils.createModal('credit-application-modal', `Credit Application - ${customer.firstName} ${customer.lastName}`, modalContent, footerButtons);
            ModalUtils.openModal('credit-application-modal');
            
            // Add SSN formatting
            const ssnInput = document.getElementById('ssn');
            if (ssnInput) {
                ssnInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 6) {
                        value = value.substring(0,3) + '-' + value.substring(3,5) + '-' + value.substring(5,9);
                    } else if (value.length >= 3) {
                        value = value.substring(0,3) + '-' + value.substring(3);
                    }
                    e.target.value = value;
                });
            }
        };

        window.viewCreditApplications = function(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            const applications = DataService.creditApplications.getByCustomerId(customerId);
            
            if (applications.length === 0) {
                ModalUtils.showErrorMessage('No credit applications found for this customer.');
                return;
            }
            
            const modalContent = `
                <div class="credit-applications-list">
                    <h4 style="margin-bottom: 1rem; color: #1f2937;">Credit Applications for ${customer.firstName} ${customer.lastName}</h4>
                    ${applications.map(app => `
                        <div class="application-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9fafb;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                <h5 style="margin: 0; color: #374151;">Application #${app.id}</h5>
                                <span class="status-badge status-${app.status.toLowerCase().replace(' ', '-')}" style="
                                    padding: 0.25rem 0.75rem; 
                                    border-radius: 9999px; 
                                    font-size: 0.75rem; 
                                    font-weight: 500;
                                    ${app.status === 'Approved' ? 'background: #dcfce7; color: #166534;' : 
                                      app.status === 'Pending' ? 'background: #fef3c7; color: #92400e;' : 
                                      app.status === 'Under Review' ? 'background: #dbeafe; color: #1e40af;' : 
                                      'background: #fee2e2; color: #dc2626;'}
                                ">${app.status}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                                <div><strong>Submitted:</strong> ${formatDate(app.dateSubmitted)}</div>
                                <div><strong>Monthly Income:</strong> $${app.monthlyIncome ? app.monthlyIncome.toLocaleString() : 'N/A'}</div>
                                <div><strong>Employer:</strong> ${app.employer || 'N/A'}</div>
                                <div><strong>Credit Score:</strong> ${app.creditScore || 'N/A'}</div>
                            </div>
                            ${app.status === 'Approved' && app.approvedAmount ? `
                                <div style="background: #dcfce7; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                    <strong style="color: #166534;">Approved Amount:</strong> $${app.approvedAmount.toLocaleString()}
                                    ${app.interestRate ? ` at ${app.interestRate}% APR` : ''}
                                </div>
                            ` : ''}
                            ${app.processingNotes ? `
                                <div style="margin-top: 0.5rem;">
                                    <strong>Notes:</strong> ${app.processingNotes}
                                </div>
                            ` : ''}
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-outline" onclick="viewApplicationDetails('${app.id}')" style="margin-right: 0.5rem;">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                ${app.status === 'Pending' || app.status === 'Under Review' ? `
                                    <button class="btn btn-outline" onclick="updateApplicationStatus('${app.id}')" style="margin-right: 0.5rem;">
                                        <i class="fas fa-edit"></i> Update Status
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const footerButtons = [
                {
                    text: 'Close',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'New Application',
                    class: 'btn-primary',
                    icon: 'fas fa-plus',
                    attributes: `onclick="ModalUtils.closeModal('view-credit-applications-modal'); openCreditApplication('${customerId}')"`
                }
            ];
            
            ModalUtils.createModal('view-credit-applications-modal', 'Credit Applications', modalContent, footerButtons);
            ModalUtils.openModal('view-credit-applications-modal');
        };

        window.viewApplicationDetails = function(applicationId) {
            const application = DataService.creditApplications.get(applicationId);
            if (!application) {
                ModalUtils.showErrorMessage('Application not found.');
                return;
            }
            
            const modalContent = `
                <div class="application-details">
                    <div class="form-section">
                        <h4 class="form-section-title">Application Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Application ID</label>
                                <input type="text" value="${application.id}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <input type="text" value="${application.status}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date Submitted</label>
                                <input type="text" value="${formatDate(application.dateSubmitted)}" readonly style="background-color: #f5f5f5;">
                            </div>
                            ${application.dateProcessed ? `
                                <div class="form-group">
                                    <label>Date Processed</label>
                                    <input type="text" value="${formatDate(application.dateProcessed)}" readonly style="background-color: #f5f5f5;">
                                </div>
                            ` : '<div class="form-group"></div>'}
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Customer Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Customer Name</label>
                                <input type="text" value="${application.customerName}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" value="${application.customerEmail}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Employment Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Employer</label>
                                <input type="text" value="${application.employer || 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Job Title</label>
                                <input type="text" value="${application.jobTitle || 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Employment Length</label>
                                <input type="text" value="${application.employmentLength || 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Monthly Income</label>
                                <input type="text" value="$${application.monthlyIncome ? application.monthlyIncome.toLocaleString() : 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Financial Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Housing Status</label>
                                <input type="text" value="${application.housingStatus || 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Monthly Housing Payment</label>
                                <input type="text" value="$${application.monthlyPayment ? application.monthlyPayment.toLocaleString() : 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Credit Score Range</label>
                                <input type="text" value="${application.creditScore || 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Down Payment</label>
                                <input type="text" value="$${application.downPayment ? application.downPayment.toLocaleString() : 'N/A'}" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>
                        ${application.tradeVehicle ? `
                            <div class="form-group">
                                <label>Trade-in Vehicle</label>
                                <input type="text" value="${application.tradeVehicle}" readonly style="background-color: #f5f5f5;">
                            </div>
                        ` : ''}
                    </div>
                    
                    ${application.status === 'Approved' && (application.approvedAmount || application.interestRate) ? `
                        <div class="form-section">
                            <h4 class="form-section-title">Approval Details</h4>
                            <div class="form-row">
                                ${application.approvedAmount ? `
                                    <div class="form-group">
                                        <label>Approved Amount</label>
                                        <input type="text" value="$${application.approvedAmount.toLocaleString()}" readonly style="background-color: #dcfce7;">
                                    </div>
                                ` : ''}
                                ${application.interestRate ? `
                                    <div class="form-group">
                                        <label>Interest Rate</label>
                                        <input type="text" value="${application.interestRate}% APR" readonly style="background-color: #dcfce7;">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${application.additionalNotes || application.processingNotes ? `
                        <div class="form-section">
                            <h4 class="form-section-title">Notes</h4>
                            ${application.additionalNotes ? `
                                <div class="form-group">
                                    <label>Customer Notes</label>
                                    <textarea readonly style="background-color: #f5f5f5;" rows="3">${application.additionalNotes}</textarea>
                                </div>
                            ` : ''}
                            ${application.processingNotes ? `
                                <div class="form-group">
                                    <label>Processing Notes</label>
                                    <textarea readonly style="background-color: #f5f5f5;" rows="3">${application.processingNotes}</textarea>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            
            const footerButtons = [
                {
                    text: 'Close',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'Update Status',
                    class: 'btn-primary',
                    icon: 'fas fa-edit',
                    attributes: `onclick="ModalUtils.closeModal('application-details-modal'); updateApplicationStatus('${applicationId}')"`
                }
            ];
            
            ModalUtils.createModal('application-details-modal', `Credit Application Details - #${application.id}`, modalContent, footerButtons);
            ModalUtils.openModal('application-details-modal');
        };

        window.updateApplicationStatus = function(applicationId) {
            const application = DataService.creditApplications.get(applicationId);
            if (!application) {
                ModalUtils.showErrorMessage('Application not found.');
                return;
            }
            
            const modalContent = `
                <form id="update-status-form">
                    <div class="form-section">
                        <h4 class="form-section-title">Update Application Status</h4>
                        <div class="form-group">
                            <label>Application ID</label>
                            <input type="text" value="#${application.id}" readonly style="background-color: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label>Customer</label>
                            <input type="text" value="${application.customerName}" readonly style="background-color: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label for="status">Status *</label>
                            <select id="status" name="status" required>
                                <option value="Pending" ${application.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Under Review" ${application.status === 'Under Review' ? 'selected' : ''}>Under Review</option>
                                <option value="Approved" ${application.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                <option value="Denied" ${application.status === 'Denied' ? 'selected' : ''}>Denied</option>
                                <option value="Cancelled" ${application.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group" id="approval-fields" style="display: ${application.status === 'Approved' ? 'block' : 'none'};">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="approved-amount">Approved Amount</label>
                                    <input type="number" id="approved-amount" name="approvedAmount" value="${application.approvedAmount || ''}" placeholder="0" min="0" step="1000">
                                </div>
                                <div class="form-group">
                                    <label for="interest-rate">Interest Rate (%)</label>
                                    <input type="number" id="interest-rate" name="interestRate" value="${application.interestRate || ''}" placeholder="0.0" min="0" max="30" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="processing-notes">Processing Notes</label>
                            <textarea id="processing-notes" name="processingNotes" rows="3" placeholder="Add notes about the decision...">${application.processingNotes || ''}</textarea>
                        </div>
                    </div>
                </form>
            `;
            
            const footerButtons = [
                {
                    text: 'Cancel',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'Update Status',
                    class: 'btn-primary',
                    icon: 'fas fa-save',
                    attributes: `onclick="saveApplicationStatus('${applicationId}')"`
                }
            ];
            
            ModalUtils.createModal('update-status-modal', 'Update Application Status', modalContent, footerButtons);
            ModalUtils.openModal('update-status-modal');
            
            // Add event listener to show/hide approval fields
            const statusSelect = document.getElementById('status');
            const approvalFields = document.getElementById('approval-fields');
            
            statusSelect.addEventListener('change', function() {
                if (this.value === 'Approved') {
                    approvalFields.style.display = 'block';
                } else {
                    approvalFields.style.display = 'none';
                }
            });
        };

        window.saveApplicationStatus = function(applicationId) {
            const form = document.getElementById('update-status-form');
            const formData = ModalUtils.getFormData(form);
            
            const updateData = {
                status: formData.status,
                processingNotes: formData.processingNotes,
                dateProcessed: new Date().toISOString()
            };
            
            if (formData.status === 'Approved') {
                if (formData.approvedAmount) {
                    updateData.approvedAmount = parseFloat(formData.approvedAmount);
                }
                if (formData.interestRate) {
                    updateData.interestRate = parseFloat(formData.interestRate);
                }
            }
            
            try {
                DataService.creditApplications.update(applicationId, updateData);
                ModalUtils.showSuccessMessage('Application status updated successfully!');
                ModalUtils.closeModal('update-status-modal');
                ModalUtils.removeModal('update-status-modal');
                
                // Refresh any open views
                if (document.getElementById('view-credit-applications-modal')) {
                    ModalUtils.closeModal('view-credit-applications-modal');
                    ModalUtils.removeModal('view-credit-applications-modal');
                }
            } catch (error) {
                console.error('Error updating application status:', error);
                ModalUtils.showErrorMessage('Error updating application status. Please try again.');
            }
        };

        window.submitCreditApplication = function() {
            const form = document.getElementById('credit-application-form');
            const errors = ModalUtils.validateForm(form);
            
            if (Object.keys(errors).length > 0) {
                ModalUtils.displayFormErrors(errors);
                return;
            }
            
            const formData = ModalUtils.getFormData(form);
            
            // Get customer information from the modal
            const modalTitle = document.querySelector('#credit-application-modal .modal-title').textContent;
            const customerName = modalTitle.replace('Credit Application - ', '');
            
            // Find customer ID by name (this is a simple approach - in production you'd pass the ID more directly)
            const customers = DataService.customers.getAll();
            const customer = customers.find(c => `${c.firstName} ${c.lastName}` === customerName);
            
            if (!customer) {
                ModalUtils.showErrorMessage('Customer information not found. Please try again.');
                return;
            }
            
            // Prepare credit application data
            const creditApplication = {
                customerId: customer.id,
                customerName: customerName,
                customerEmail: customer.email,
                ...formData,
                status: 'Pending'
            };
            
            // Save the credit application
            try {
                DataService.creditApplications.add(creditApplication);
                ModalUtils.showSuccessMessage('Credit application submitted successfully! You will be notified of the decision within 24 hours.');
                ModalUtils.closeModal('credit-application-modal');
                ModalUtils.removeModal('credit-application-modal');
                
                // Refresh the customer view to show the new application
                if (typeof loadCustomers === 'function') {
                    loadCustomers();
                }
            } catch (error) {
                console.error('Error saving credit application:', error);
                ModalUtils.showErrorMessage('Error submitting credit application. Please try again.');
            }
        };

        // Utility function for date formatting
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Customer Management functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Clean up any existing modals first
            cleanupExistingModals();
            
            // Initialize data
            DataService.utils.initializeAllData();
            
            // Load customers
            loadCustomers();
            updateStats();
            
            // Event listeners
            setupEventListeners();
        });

        function cleanupExistingModals() {
            // Remove any existing customer modals that might be left over
            const existingModals = ['add-customer-modal', 'view-customer-modal', 'edit-customer-modal'];
            existingModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                }
            });
        }

        function setupEventListeners() {
            console.log('Setting up customer event listeners...');
            
            // New Customer Button (in top nav)
            const newCustomerBtn = document.querySelector('.top-nav-actions .btn-primary');
            console.log('New Customer Button:', newCustomerBtn);
            if (newCustomerBtn) {
                newCustomerBtn.addEventListener('click', function(e) {
                    console.log('New Customer button clicked');
                    openAddCustomerModal();
                });
            }
            
            // Add First Customer Button
            const addFirstCustomerBtn = document.getElementById('add-first-customer');
            console.log('Add First Customer Button:', addFirstCustomerBtn);
            if (addFirstCustomerBtn) {
                addFirstCustomerBtn.addEventListener('click', function(e) {
                    console.log('Add First Customer button clicked');
                    openAddCustomerModal();
                });
            }
            
            // Search functionality
            const searchInput = document.getElementById('customer-search');
            if (searchInput) {
                searchInput.addEventListener('input', filterCustomers);
            }
            
            // Search criteria dropdown functionality
            const searchCriteriaSelect = document.getElementById('search-criteria');
            if (searchCriteriaSelect) {
                searchCriteriaSelect.addEventListener('change', function() {
                    // Update placeholder text based on selected criteria
                    const searchInput = document.getElementById('customer-search');
                    const selectedCriteria = this.value;
                    
                    switch (selectedCriteria) {
                        case 'name':
                            searchInput.placeholder = 'Search by name...';
                            break;
                        case 'phone':
                            searchInput.placeholder = 'Search by phone number...';
                            break;
                        case 'email':
                            searchInput.placeholder = 'Search by email...';
                            break;
                        case 'company':
                            searchInput.placeholder = 'Search by company...';
                            break;
                        case 'all':
                        default:
                            searchInput.placeholder = 'Search customers...';
                            break;
                    }
                    
                    // Re-run filter if there's already a search term
                    if (searchInput.value.trim()) {
                        filterCustomers();
                    }
                });
            }
            
            // Filter functionality
            const filterSelect = document.getElementById('customer-filter');
            if (filterSelect) {
                filterSelect.addEventListener('change', filterCustomers);
            }
            
            // Date Range Filter Change
            const dateRangeSelect = document.getElementById('date-range');
            if (dateRangeSelect) {
                dateRangeSelect.addEventListener('change', function() {
                    console.log('Date range changed to:', this.value);
                    filterCustomersByDateRange(this.value);
                });
            }

            // Filter button functionality
            const filterBtn = document.getElementById('customer-filter-btn');
            if (filterBtn) {
                filterBtn.addEventListener('click', function() {
                    filterCustomers();
                });
            }
            
            // Notification Bell
            const notificationBell = document.querySelector('.notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', function() {
                    alert('Notifications feature coming soon!');
                });
            }
            
            // Initialize import/export listeners
            initCustomersImportExportListeners();
        }
        


        function loadCustomers() {
            filterCustomers();
        }

        function updateStats() {
            const customers = DataService.customers.getAll();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // Total customers
            document.getElementById('total-customers').textContent = customers.length;
            
            // New customers this month
            const newThisMonth = customers.filter(customer => {
                const dateAdded = new Date(customer.dateAdded);
                return dateAdded.getMonth() === currentMonth && dateAdded.getFullYear() === currentYear;
            }).length;
            document.getElementById('new-customers').textContent = newThisMonth;
            
            // VIP customers
            const vipCustomers = customers.filter(customer => customer.type === 'VIP').length;
            document.getElementById('vip-customers').textContent = vipCustomers;
            
            // Active deals (placeholder - would need to check deals data)
            document.getElementById('active-deals').textContent = '0';
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const searchCriteria = document.getElementById('search-criteria').value;
            const filterType = document.getElementById('customer-filter').value;
            const customers = DataService.customers.getAll();
            
            let filteredCustomers = customers;
            
            // Apply search filter based on selected criteria
            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(customer => {
                    switch (searchCriteria) {
                        case 'name':
                            return customer.firstName.toLowerCase().includes(searchTerm) ||
                                   customer.lastName.toLowerCase().includes(searchTerm);
                        case 'phone':
                            // Normalize both phone and searchTerm to digits only for matching
                            const customerPhoneDigits = customer.phone.replace(/\D/g, '');
                            const searchDigits = searchTerm.replace(/\D/g, '');
                            return customerPhoneDigits.includes(searchDigits);
                        case 'email':
                            return customer.email.toLowerCase().includes(searchTerm);
                        case 'company':
                            return customer.company && customer.company.toLowerCase().includes(searchTerm);
                        case 'all':
                        default:
                            // Normalize phone search for 'all' criteria as well
                            const customerPhoneDigitsAll = customer.phone.replace(/\D/g, '');
                            const searchDigitsAll = searchTerm.replace(/\D/g, '');
                            return customer.firstName.toLowerCase().includes(searchTerm) ||
                                   customer.lastName.toLowerCase().includes(searchTerm) ||
                                   customer.email.toLowerCase().includes(searchTerm) ||
                                   customerPhoneDigitsAll.includes(searchDigitsAll) ||
                                   (customer.company && customer.company.toLowerCase().includes(searchTerm));
                    }
                });
            }
            
            // Apply type filter
            if (filterType) {
                filteredCustomers = filteredCustomers.filter(customer => customer.type === filterType);
            }
            
            // Update table
            const tbody = document.getElementById('customers-tbody');
            const noCustomersDiv = document.getElementById('no-customers');
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '';
                noCustomersDiv.style.display = 'block';
                noCustomersDiv.querySelector('h3').textContent = 'No Customers Found';
                noCustomersDiv.querySelector('p').textContent = 'Try adjusting your search or filter criteria.';
            } else {
                noCustomersDiv.style.display = 'none';
                tbody.innerHTML = filteredCustomers.map(customer => `
                    <tr>
                        <td>
                            <div class="customer-info">
                                <div class="customer-avatar">
                                    ${customer.firstName.charAt(0)}${customer.lastName.charAt(0)}
                                </div>
                                <div>
                                    <div class="customer-name">${customer.firstName} ${customer.lastName}</div>
                                    <div class="customer-company">${customer.company || 'Individual'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-info">
                                <div><i class="fas fa-phone"></i> ${customer.phone}</div>
                                <div><i class="fas fa-envelope"></i> ${customer.email}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-${customer.type ? customer.type.toLowerCase() : 'regular'}">${customer.type || 'Regular'}</span>
                        </td>
                        <td>${formatDate(customer.dateAdded)}</td>
                        <td>${formatDate(customer.lastContact)}</td>
                        <td>
                            <span class="purchase-count">${customer.purchaseHistory ? customer.purchaseHistory.length : 0}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="viewCustomer('${customer.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon" onclick="editCustomer('${customer.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <div class="dropdown-menu-wrapper">
                                    <button class="btn-icon" title="More Options" onclick="toggleCustomerDropdownMenu(this)">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu" style="display:none;position:absolute;right:0;z-index:10;min-width:120px;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                        <button class="dropdown-item" style="width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="createDealForCustomer('${customer.id}')">Create New Deal</button>
                                        <button class="dropdown-item" style="width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="openCreditApplication('${customer.id}')">Credit Application</button>
                                        <button class="dropdown-item" style="width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="viewCreditApplications('${customer.id}')">View Applications</button>
                                        <button class="dropdown-item" style="width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="sendEmailToCustomer('${customer.id}')">Send Email</button>
                                        <button class="dropdown-item" style="width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="logCallForCustomer('${customer.id}')">Log Call</button>
                                        <button class="dropdown-item" style="width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="addNoteToCustomer('${customer.id}')">Add Note</button>
                                        <button class="dropdown-item" style="color:#e53e3e;width:100%;text-align:left;padding:8px 16px;border:none;background:none;cursor:pointer;" onclick="deleteCustomer('${customer.id}')">Delete</button>
                                    </div>
                                </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function toggleCustomerDropdownMenu(btn) {
            var menu = btn.parentElement.querySelector('.dropdown-menu');
            // Hide other open menus
            document.querySelectorAll('.dropdown-menu').forEach(function(m) { if (m !== menu) m.style.display = 'none'; });
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-menu-wrapper')) {
                document.querySelectorAll('.dropdown-menu').forEach(function(menu) { menu.style.display = 'none'; });
            }
        });

        function openAddCustomerModal() {
            const modalContent = `
                <form id="add-customer-form">
                    <div class="form-section">
                        <h4 class="form-section-title">Personal Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name *</label>
                                <input type="text" id="firstName" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name *</label>
                                <input type="text" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone *</label>
                                <input type="tel" id="phone" name="phone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="company">Company</label>
                            <input type="text" id="company" name="company">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Address Information</h4>
                        <div class="form-group">
                            <label for="address">Street Address</label>
                            <input type="text" id="address" name="address">
                        </div>
                        <div class="form-row-3">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" name="city">
                            </div>
                            <div class="form-group">
                                <label for="state">State</label>
                                <input type="text" id="state" name="state">
                            </div>
                            <div class="form-group">
                                <label for="zipCode">ZIP Code</label>
                                <input type="text" id="zipCode" name="zipCode">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Customer Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="type">Customer Type</label>
                                <select id="type" name="type">
                                    <option value="Regular">Regular</option>
                                    <option value="VIP">VIP</option>
                                    <option value="New">New</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="source">Lead Source</label>
                                <select id="source" name="source">
                                    <option value="">Select Source</option>
                                    <option value="Website">Website</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Walk-in">Walk-in</option>
                                    <option value="Phone">Phone</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Advertisement">Advertisement</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Additional notes about the customer..."></textarea>
                        </div>
                    </div>
                </form>
            `;
            
            const footerButtons = [
                {
                    text: 'Cancel',
                    class: 'btn-outline',
                    attributes: 'data-modal-close'
                },
                {
                    text: 'Add Customer',
                    class: 'btn-primary',
                    icon: 'fas fa-plus',
                    attributes: 'onclick="saveCustomer()"'
                }
            ];
            
            ModalUtils.createModal('add-customer-modal', 'Add New Customer', modalContent, footerButtons);
            ModalUtils.openModal('add-customer-modal');
        }

        function saveCustomer() {
            const form = document.getElementById('add-customer-form');
            const errors = ModalUtils.validateForm(form);
            
            if (Object.keys(errors).length > 0) {
                ModalUtils.displayFormErrors(errors);
                return;
            }
            
            const formData = ModalUtils.getFormData(form);
            
            // Create customer object
            const customer = {
                firstName: formData.firstName,
                lastName: formData.lastName,
                email: formData.email,
                phone: formData.phone,
                company: formData.company || '',
                address: formData.address || '',
                city: formData.city || '',
                state: formData.state || '',
                zipCode: formData.zipCode || '',
                type: formData.type || 'Regular',
                source: formData.source || '',
                notes: formData.notes || '',
                lastContact: new Date().toISOString().split('T')[0],
                purchaseHistory: []
            };
            
            // Save customer
            DataService.customers.add(customer);
            
            // Close modal and refresh
            ModalUtils.closeModal('add-customer-modal');
            ModalUtils.removeModal('add-customer-modal');
            ModalUtils.showSuccessMessage('Customer added successfully!');
            
            // Refresh the page data
            loadCustomers();
            updateStats();
        }

        function editCustomer(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) return;
            
            // Similar to add modal but pre-populated with customer data
            openAddCustomerModal();
            
            // Change modal title and button
            document.querySelector('#add-customer-modal .modal-title').textContent = 'Edit Customer';
            document.querySelector('#add-customer-modal .btn-primary').textContent = 'Update Customer';
            document.querySelector('#add-customer-modal .btn-primary').setAttribute('onclick', `updateCustomer('${customerId}')`);
            
            // Populate form with customer data
            const form = document.getElementById('add-customer-form');
            ModalUtils.populateForm(form, customer);
        }

        function updateCustomer(customerId) {
            const form = document.getElementById('add-customer-form');
            const errors = ModalUtils.validateForm(form);
            
            if (Object.keys(errors).length > 0) {
                ModalUtils.displayFormErrors(errors);
                return;
            }
            
            const formData = ModalUtils.getFormData(form);
            const customer = DataService.customers.get(customerId);
            
            // Update customer object
            Object.assign(customer, {
                firstName: formData.firstName,
                lastName: formData.lastName,
                email: formData.email,
                phone: formData.phone,
                company: formData.company || '',
                address: formData.address || '',
                city: formData.city || '',
                state: formData.state || '',
                zipCode: formData.zipCode || '',
                type: formData.type || 'Regular',
                source: formData.source || '',
                notes: formData.notes || ''
            });
            
            // Save updated customer
            DataService.customers.update(customer);
            
            // Close modal and refresh
            ModalUtils.closeModal('add-customer-modal');
            ModalUtils.removeModal('add-customer-modal');
            ModalUtils.showSuccessMessage('Customer updated successfully!');
            
            // Refresh the page data
            loadCustomers();
            updateStats();
        }



        function deleteCustomer(customerId) {
            const customer = DataService.customers.get(customerId);
            if (!customer) return;
            if (confirm(`Are you sure you want to delete ${customer.firstName} ${customer.lastName}? This action cannot be undone.`)) {
                DataService.customers.remove(customerId);
                ModalUtils.showSuccessMessage('Customer deleted successfully!');
                loadCustomers();
                updateStats();
            }
        }
// Ensure global availability of deleteCustomer after all functions
window.deleteCustomer = deleteCustomer;

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function filterCustomersByDateRange(dateRange) {
            console.log('Filtering customers by date range:', dateRange);
            
            // Get filtered customers based on date range
            const filteredCustomers = DateFilterUtils.getFilteredData('customers', dateRange);
            
            // Update the customers table with filtered data
            const tbody = document.getElementById('customers-tbody');
            const noCustomersDiv = document.getElementById('no-customers');
            
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '';
                noCustomersDiv.style.display = 'block';
                noCustomersDiv.querySelector('h3').textContent = 'No Customers Found';
                noCustomersDiv.querySelector('p').textContent = `No customers found for the selected date range: ${dateRange}`;
            } else {
                noCustomersDiv.style.display = 'none';
                tbody.innerHTML = filteredCustomers.map(customer => `
                    <tr>
                        <td>
                            <div class="customer-info">
                                <div class="customer-avatar">
                                    ${customer.firstName.charAt(0)}${customer.lastName.charAt(0)}
                                </div>
                                <div class="customer-details">
                                    <div class="customer-name">${customer.firstName} ${customer.lastName}</div>
                                    <div class="customer-company">${customer.company || 'Individual Customer'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-info">
                                <div class="email">${customer.email}</div>
                                <div class="phone">${customer.phone}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-${customer.type.toLowerCase().replace(' ', '-')}">${customer.type}</span>
                        </td>
                        <td>
                            <span class="source">${customer.source || 'Not specified'}</span>
                        </td>
                        <td>
                            <span class="date">${formatDate(customer.dateAdded)}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="viewCustomer('${customer.id}')" title="View Customer">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon" onclick="editCustomer('${customer.id}')" title="Edit Customer">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-danger" onclick="deleteCustomer('${customer.id}')" title="Delete Customer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update stats with filtered data
            updateStatsWithFilteredCustomers(filteredCustomers);
        }
        
        function updateStatsWithFilteredCustomers(filteredCustomers) {
            // Calculate stats for filtered customers
            const totalCustomers = filteredCustomers.length;
            const newCustomers = filteredCustomers.filter(customer => customer.type === 'New');
            const returningCustomers = filteredCustomers.filter(customer => customer.type === 'Returning');
            
            // Update stats display (if stats elements exist)
            const totalCustomersElement = document.querySelector('.stat-total-customers');
            const newCustomersElement = document.querySelector('.stat-new-customers');
            const returningCustomersElement = document.querySelector('.stat-returning-customers');
            
            if (totalCustomersElement) totalCustomersElement.textContent = totalCustomers;
            if (newCustomersElement) newCustomersElement.textContent = newCustomers.length;
            if (returningCustomersElement) returningCustomersElement.textContent = returningCustomers.length;
        }
    </script>
</body>
</html>
